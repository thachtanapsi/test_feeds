defmodule UdpSender do
  use GenServer

  @socket_count 100

  # API

  def start_link(opts \\ []) do
    GenServer.start_link(__MODULE__, :ok, opts ++ [name: __MODULE__])
  end

  @doc """
    UdpSender.send_udp("hello", {127, 0, 0, 1}, 4000)

    "8=FIX.4.4|9=495|35=d|49=VNMGW|56=99999|34=1|52=20250527 01:00:09.684|30001=STO|20004=G1|911=4228|207=HO|55=VN000000AAA4|30624=AAA|30628=21|30629=Công ty Cổ phần Nhựa An Phát Xanh|30630=An Phat Bioplastics Joint Stock Company|20009=S1STOST|20003=STO|30604=ST|106=VSDAAAXX|231=1.0|223=0.0|15=VND|20020=382274496|1149=7860.0|1148=6840.0|202=0.0|965=N|30631=1.0|236=0.0|20013=7350.0|20014=0.0|20015=0.0|20016=0.0|140=7350.0|20027=1|30301=20161125|30614=0|20018=00|30625=7290.0|30635=NRM|30636=NRM|30637=NRM|10=036|"  |> String.replace("|", << 0x01 >>) |> UdpSender.send_udp({127, 0, 0, 1}, 5000)
    type d
    "8=FIX.4.4|9=495|35=d|49=VNMGW|56=99999|34=2|52=20250527 01:00:09.684|30001=STO|20004=G1|911=4228|207=HO|55=VN000000AAA4|30624=AAA|30628=21|30629=Công ty Cổ phần Nhựa An Phát Xanh|30630=An Phat Bioplastics Joint Stock Company|20009=S1STOST|20003=STO|30604=ST|106=VSDAAAXX|231=1.0|223=0.0|15=VND|20020=382274496|1149=7860.0|1148=6840.0|202=0.0|965=N|30631=1.0|236=0.0|20013=7350.0|20014=0.0|20015=0.0|20016=0.0|140=7350.0|20027=1|30301=20161125|30614=0|20018=00|30625=7290.0|30635=NRM|30636=NRM|30637=NRM|10=036|"  |> String.replace("|", << 0x01 >>) |> UdpSender.send_udp({127, 0, 0, 1}, 5000)

    type X
    "8=FIX.4.4|9=396|35=X|49=VNMGW|56=99999|34=4|52=20250527 02:00:00.255|30001=STO|20004=G7|336=99|55=VN000000AAA4|75=20250527|60=020000251|268=6|83=1|279=0|269=1|290=1|270=0.0|271=0|30271=0|83=2|279=0|269=0|290=1|270=0.0|271=0|30271=0|83=3|279=0|269=1|290=2|270=0.0|271=0|30271=0|83=4|279=0|269=0|290=2|270=0.0|271=0|30271=0|83=5|279=0|269=1|290=3|270=0.0|271=0|30271=0|83=6|279=0|269=0|290=3|270=0.0|271=0|30271=0|10=067|"  |> String.replace("|", << 0x01 >>) |> UdpSender.send_udp({127, 0, 0, 1}, 5000)
    "8=FIX.4.4|9=396|35=X|49=VNMGW|56=99999|34=4|52=20250527 02:00:00.255|30001=STO|20004=G7|336=99|55=VN000000AAA4|75=20250527|60=020000251|268=6|83=1|279=0|269=1|290=1|270=0.0|271=0|30271=0|83=2|279=0|269=0|290=1|270=0.0|271=0|30271=0|83=3|279=0|269=1|290=2|270=0.0|271=0|30271=0|83=4|279=0|269=0|290=2|270=0.0|271=0|30271=0|83=5|279=0|269=1|290=3|270=0.0|271=0|30271=0|83=6|279=0|269=0|290=3|270=0.0|271=0|30271=0|10=067|"  |> String.replace("|", << 0x01 >>) |> UdpSender.send_udp({127, 0, 0, 1}, 5000)

    type X 2
    "8=FIX.4.4|9=383|35=X|49=VNMGW|56=99999|34=1026673|52=20250527 03:46:09.571|30001=STO|20004=G1|336=40|55=VN000000CTR4|75=20250527|60=034609568|387=205700|381=19227640000.0|268=4|83=1|279=0|269=2|290=0|270=94400.0|271=200|346=0|30271=0|83=2|279=0|269=4|290=0|270=93000.0|271=0|346=0|30271=0|83=3|279=0|269=7|290=0|270=94400.0|271=0|346=0|30271=0|83=4|279=0|269=8|290=0|270=92500.0|271=0|346=0|30271=0|10=066|" |> String.replace("|", << 0x01 >>) |> UdpSender.send_udp({127, 0, 0, 1}, 5000)
    "8=FIX.4.4|9=386|35=X|49=VNMGW|56=99999|34=1026674124|52=20250527 03:46:09.571|30001=STO|20004=G1|336=40|55=VN000000CTR4|75=20250527|60=034609568|387=205700|381=19227640000.0|268=4|83=1|279=0|269=2|290=0|270=94400.0|271=200|346=0|30271=0|83=2|279=0|269=4|290=0|270=93000.0|271=0|346=0|30271=0|83=3|279=0|269=7|290=0|270=94400.0|271=0|346=0|30271=0|83=4|279=0|269=8|290=0|270=92500.0|271=0|346=0|30271=0|10=067|" |> String.replace("|", << 0x01 >>) |> UdpSender.send_udp({127, 0, 0, 1}, 5000)
    "8=FIX.4.4|9=386|35=X|49=VNMGW|56=99999|34=1026674125|52=20250527 03:46:09.571|30001=STO|20004=G1|336=40|55=VN000000CTR4|75=20250527|60=034609568|387=205700|381=19227640000.0|268=4|83=1|279=0|269=2|290=0|270=94500.0|271=300|346=0|30271=0|83=2|279=0|269=4|290=0|270=93000.0|271=0|346=0|30271=0|83=3|279=0|269=7|290=0|270=94400.0|271=0|346=0|30271=0|83=4|279=0|269=8|290=0|270=92500.0|271=0|346=0|30271=0|10=067|" |> String.replace("|", << 0x01 >>) |> UdpSender.send_udp({127, 0, 0, 1}, 5000)
    "8=FIX.4.4|9=386|35=X|49=VNMGW|56=99999|34=1026674126|52=20250527 03:46:09.571|30001=STO|20004=G1|336=40|55=VN000000CTR4|75=20250527|60=034609568|387=205700|381=19227640000.0|268=4|83=1|279=0|269=2|290=0|270=94600.0|271=100|346=0|30271=0|83=2|279=0|269=4|290=0|270=93000.0|271=0|346=0|30271=0|83=3|279=0|269=7|290=0|270=94400.0|271=0|346=0|30271=0|83=4|279=0|269=8|290=0|270=92500.0|271=0|346=0|30271=0|10=067|" |> String.replace("|", << 0x01 >>) |> UdpSender.send_udp({127, 0, 0, 1}, 5000)
    "8=FIX.4.4|9=386|35=X|49=VNMGW|56=99999|34=1026674127|52=20250527 03:46:09.571|30001=STO|20004=G1|336=40|55=VN000000CTR4|75=20250527|60=034609568|387=205700|381=19227640000.0|268=4|83=1|279=0|269=2|290=0|270=94700.0|271=500|346=0|30271=0|83=2|279=0|269=4|290=0|270=93000.0|271=0|346=0|30271=0|83=3|279=0|269=7|290=0|270=94400.0|271=0|346=0|30271=0|83=4|279=0|269=8|290=0|270=92500.0|271=0|346=0|30271=0|10=067|" |> String.replace("|", << 0x01 >>) |> UdpSender.send_udp({127, 0, 0, 1}, 5000)
    "8=FIX.4.4|9=386|35=X|49=VNMGW|56=99999|34=1026674128|52=20250527 03:46:09.571|30001=STO|20004=G1|336=40|55=VN000000CTR4|75=20250527|60=034609568|387=205700|381=19227640000.0|268=4|83=1|279=0|269=2|290=0|270=94300.0|271=900|346=0|30271=0|83=2|279=0|269=4|290=0|270=93000.0|271=0|346=0|30271=0|83=3|279=0|269=7|290=0|270=94400.0|271=0|346=0|30271=0|83=4|279=0|269=8|290=0|270=92500.0|271=0|346=0|30271=0|10=067|" |> String.replace("|", << 0x01 >>) |> UdpSender.send_udp({127, 0, 0, 1}, 5000)
    "8=FIX.4.4|9=386|35=X|49=VNMGW|56=99999|34=1026674129|52=20250527 03:46:09.571|30001=STO|20004=G1|336=40|55=VN000000CTR4|75=20250527|60=034609568|387=205700|381=19227640000.0|268=4|83=1|279=0|269=2|290=0|270=94000.0|271=100|346=0|30271=0|83=2|279=0|269=4|290=0|270=93000.0|271=0|346=0|30271=0|83=3|279=0|269=7|290=0|270=94400.0|271=0|346=0|30271=0|83=4|279=0|269=8|290=0|270=92500.0|271=0|346=0|30271=0|10=067|" |> String.replace("|", << 0x01 >>) |> UdpSender.send_udp({127, 0, 0, 1}, 5000)
    "8=FIX.4.4|9=386|35=X|49=VNMGW|56=99999|34=1026674130|52=20250527 03:46:09.571|30001=STO|20004=G1|336=40|55=VN000000CTR4|75=20250527|60=034609568|387=205700|381=19227640000.0|268=4|83=1|279=0|269=2|290=0|270=94100.0|271=800|346=0|30271=0|83=2|279=0|269=4|290=0|270=93000.0|271=0|346=0|30271=0|83=3|279=0|269=7|290=0|270=94400.0|271=0|346=0|30271=0|83=4|279=0|269=8|290=0|270=92500.0|271=0|346=0|30271=0|10=067|" |> String.replace("|", << 0x01 >>) |> UdpSender.send_udp({127, 0, 0, 1}, 5000)
    "8=FIX.4.4|9=386|35=X|49=VNMGW|56=99999|34=1026674131|52=20250527 03:46:09.571|30001=STO|20004=G1|336=40|55=VN000000CTR4|75=20250527|60=034609568|387=205700|381=19227640000.0|268=4|83=1|279=0|269=2|290=0|270=94200.0|271=700|346=0|30271=0|83=2|279=0|269=4|290=0|270=93000.0|271=0|346=0|30271=0|83=3|279=0|269=7|290=0|270=94400.0|271=0|346=0|30271=0|83=4|279=0|269=8|290=0|270=92500.0|271=0|346=0|30271=0|10=067|" |> String.replace("|", << 0x01 >>) |> UdpSender.send_udp({127, 0, 0, 1}, 5000)
    "8=FIX.4.4|9=386|35=X|49=VNMGW|56=99999|34=1026674132|52=20250527 03:46:09.571|30001=STO|20004=G1|336=40|55=VN000000CTR4|75=20250527|60=034609568|387=205700|381=19227640000.0|268=4|83=1|279=0|269=2|290=0|270=94300.0|271=600|346=0|30271=0|83=2|279=0|269=4|290=0|270=93000.0|271=0|346=0|30271=0|83=3|279=0|269=7|290=0|270=94400.0|271=0|346=0|30271=0|83=4|279=0|269=8|290=0|270=92500.0|271=0|346=0|30271=0|10=067|" |> String.replace("|", << 0x01 >>) |> UdpSender.send_udp({127, 0, 0, 1}, 5000)
    "8=FIX.4.4|9=386|35=X|49=VNMGW|56=99999|34=1026674133|52=20250527 03:46:09.571|30001=STO|20004=G1|336=40|55=VN000000CTR4|75=20250527|60=034609568|387=205700|381=19227640000.0|268=4|83=1|279=0|269=2|290=0|270=94400.0|271=300|346=0|30271=0|83=2|279=0|269=4|290=0|270=93000.0|271=0|346=0|30271=0|83=3|279=0|269=7|290=0|270=94400.0|271=0|346=0|30271=0|83=4|279=0|269=8|290=0|270=92500.0|271=0|346=0|30271=0|10=067|" |> String.replace("|", << 0x01 >>) |> UdpSender.send_udp({127, 0, 0, 1}, 5000)
    "8=FIX.4.4|9=386|35=X|49=VNMGW|56=99999|34=1026674134|52=20250527 03:46:09.571|30001=STO|20004=G1|336=40|55=VN000000CTR4|75=20250527|60=034609568|387=205700|381=19227640000.0|268=4|83=1|279=0|269=2|290=0|270=94000.0|271=200|346=0|30271=0|83=2|279=0|269=4|290=0|270=93000.0|271=0|346=0|30271=0|83=3|279=0|269=7|290=0|270=94400.0|271=0|346=0|30271=0|83=4|279=0|269=8|290=0|270=92500.0|271=0|346=0|30271=0|10=067|" |> String.replace("|", << 0x01 >>) |> UdpSender.send_udp({127, 0, 0, 1}, 5000)
"
  """

  def send_udp(payload, ip, port) do
    GenServer.cast(__MODULE__, {:send_udp, payload, ip, port})
  end

  # GenServer callbacks

  def init(:ok) do
    # Open N sockets and store as list
    sockets =
      for _ <- 1..@socket_count do
        {:ok, sock} = :gen_udp.open(0)
        sock
      end

    state = %{sockets: sockets, next: 0}
    {:ok, state}
  end

  def handle_cast({:send_udp, payload, ip, port}, %{sockets: sockets, next: next} = state) do
    socket = Enum.at(sockets, rem(next, @socket_count))
    :gen_udp.send(socket, ip, port, payload)
    {:noreply, %{state | next: next + 1}}
  end

  def terminate(_reason, %{sockets: sockets}) do
    Enum.each(sockets, &:gen_udp.close/1)
    :ok
  end
end
